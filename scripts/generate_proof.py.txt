#!/usr/bin/env python3
# scripts/generate_proof.py
# Usage: python scripts/generate_proof.py <commit-hash>
# Output: prints base64 encrypted signature to stdout

import sys
import base64
from pathlib import Path
from cryptography.hazmat.primitives import hashes, serialization
from cryptography.hazmat.primitives.asymmetric import padding, rsa
from cryptography.hazmat.primitives.asymmetric import utils as asym_utils

def load_private_key(path: Path):
    data = path.read_bytes()
    return serialization.load_pem_private_key(data, password=None)

def load_public_key(path: Path):
    data = path.read_bytes()
    return serialization.load_pem_public_key(data)

def sign_commit_hash(commit_hash: str, private_key) -> bytes:
    # Sign ASCII bytes of commit hash with RSA-PSS, SHA256, max salt length
    msg = commit_hash.encode("ascii")
    signature = private_key.sign(
        msg,
        padding.PSS(
            mgf=padding.MGF1(hashes.SHA256()),
            salt_length=padding.PSS.MAX_LENGTH
        ),
        hashes.SHA256()
    )
    return signature

def encrypt_signature(sig: bytes, pubkey) -> bytes:
    # Encrypt signature with RSA-OAEP SHA-256
    ciphertext = pubkey.encrypt(
        sig,
        padding.OAEP(
            mgf=padding.MGF1(algorithm=hashes.SHA256()),
            algorithm=hashes.SHA256(),
            label=None
        )
    )
    return ciphertext

def main():
    if len(sys.argv) < 2:
        print("Usage: python scripts/generate_proof.py <commit-hash>")
        sys.exit(2)

    commit_hash = sys.argv[1].strip()
    if len(commit_hash) != 40:
        print("Warning: commit hash length is not 40 characters - continuing anyway.")

    priv_path = Path("student_private.pem")
    instr_pub_path = Path("instructor_public.pem")

    if not priv_path.exists() or not instr_pub_path.exists():
        print("Error: key files missing. Ensure student_private.pem and instructor_public.pem are present.")
        sys.exit(1)

    private_key = load_private_key(priv_path)
    instructor_pub = load_public_key(instr_pub_path)

    signature = sign_commit_hash(commit_hash, private_key)
    ciphertext = encrypt_signature(signature, instructor_pub)
    b64 = base64.b64encode(ciphertext).decode("ascii")
    print(b64)

if __name__ == "__main__":
    main()
